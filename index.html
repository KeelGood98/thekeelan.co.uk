<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>thekeelan.co.uk</title>

  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <meta name="theme-color" content="#0b0f14" />

  <style>
    :root{
      --text:#e9eef5; --muted:#9aa6b2; --card:#12161b; --border:#1e242c; --accent:#6ee7ff; --accent2:#a78bfa;
      --hdr:72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.80)),
        url('https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?auto=format&fit=crop&w=2400&q=60') center top / cover no-repeat fixed;
      background-color:#0b0f14;
    }

    .site-header{
      position: sticky; top: 0; z-index: 50;
      display:flex; align-items:center; gap:12px; padding:10px 18px;
      backdrop-filter: blur(8px);
      background: rgba(11,15,20,0.6);
      border-bottom: 1px solid var(--border);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brand-logo{width:28px;height:28px;border-radius:6px;background:
      radial-gradient(circle at 30% 30%,#6ee7ff,transparent 40%),
      radial-gradient(circle at 70% 70%,#a78bfa,transparent 40%); box-shadow:0 0 0 1px #2a3340 inset}
    .brand h1{margin:0;font-size:18px}
    .spacer{flex:1}
    #lastUpdated{white-space:nowrap}

    .nav{display:flex; gap:10px; align-items:center}
    .nav a{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      color:var(--muted); text-decoration:none; transition:all .18s ease;
    }
    .nav a:hover{ color:var(--text); border-color:#2a3340; background:#0f141a; }
    .nav a.active{
      color:var(--text);
      border-color:transparent;
      background: linear-gradient(90deg, rgba(110,231,255,.20), rgba(167,139,250,.20));
      box-shadow: 0 0 0 1px rgba(110,231,255,.25) inset;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1.6fr 1.2fr;
      gap:18px;
      padding:12px 18px 24px;
      align-items:start;
    }
    @media (max-width: 1200px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)
    }
    .card h2{margin:0 0 8px}
    .muted{color:var(--muted)}
    .stretch{display:flex;flex-direction:column;height:calc(100dvh - var(--hdr) - 24px);min-height:420px}
    .panel{border:1px solid var(--border);border-radius:10px;overflow:auto;flex:1;min-height:0}
    iframe{width:100%;border:0;border-radius:10px}

    /* tables / pills */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:center}
    thead th{position:sticky;top:0;background:#0f141a;z-index:1}
    tr:hover td{background:#0f141a}
    .team-cell{display:flex;align-items:center;justify-content:center;gap:8px}
    .badge{
      width:20px;height:20px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      background:#0f141a;font-weight:700;font-size:11px;letter-spacing:.5px
    }
    .badge.img{background:none}
    .badge.initials{background: radial-gradient(closest-side, #1a2430, #0f141a);border:1px solid #243041;color:#b6c2cf;text-transform:uppercase}

    /* fixtures/results cards (green win, amber draw, red loss) */
    .row-card{border:1px solid var(--border);border-radius:12px;margin:8px 0;padding:10px 12px}
    .row-card.win{background:rgba(16,54,31,.55)}
    .row-card.draw{background:rgba(43,43,23,.55)}
    .row-card.loss{background:rgba(58,26,26,.55)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:999px;background:#0f141a;font-size:12px}

    /* F1 chips */
    .driver-chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#0f141a;font-size:12px}
    .driver-chip .dot{width:8px;height:8px;border-radius:50%}
    .driver-chip.p1 .dot{background:#d4af37}
    .driver-chip.p2 .dot{background:#bfbfbf}
    .driver-chip.p3 .dot{background:#cd7f32}
    .driver-chip .team{opacity:.7;margin-left:2px}
  </style>
</head>
<body>
  <header id="siteHeader" class="site-header">
    <div class="brand">
      <div class="brand-logo" aria-hidden="true"></div>
      <h1>thekeelan.co.uk</h1>
    </div>
    <div class="spacer"></div>
    <div class="muted" id="lastUpdated">Last updated: —</div>
    <nav class="nav" aria-label="Primary">
      <a href="/" class="active" title="Football">Football</a>
      <a href="/extras.html" title="Extras">Extras</a>
    </nav>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section class="card stretch">
      <h2>Left Panel</h2>
      <div class="panel" style="overflow:hidden">
        <img src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExcThlOWlqcmc5YnZmcTVtaDByZHdpZHd4cWo4YTl0NXB4NGlxNnFlaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/yRl0DstAx4nN0RjDLV/giphy.gif"
             alt="gif" style="display:block;width:100%;height:auto;">
      </div>

      <!-- F1 block -->
      <div class="card" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;flex:1;min-height:0">
        <h2 id="f1Title">F1 — This Season (Results)</h2>
        <div id="f1Wrap" class="panel" style="padding:8px;">
          <div class="muted">Loading…</div>
        </div>
      </div>
    </section>

    <!-- CENTRE -->
    <section class="card" style="align-self:start;height:max-content;">
      <h2>Premier League Table</h2>
      <div style="border:1px solid var(--border);border-radius:10px;overflow:auto;">
        <table>
          <thead>
            <tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="10" class="muted">Waiting for data…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card stretch">
      <h2>Man United – Fixtures & Results</h2>
      <div id="fixturesWrap" class="panel" style="padding:8px;">
        <div class="muted">Waiting for data…</div>
      </div>
    </section>
  </div>

<script>
/* header height for stretch columns */
function setHeaderVar(){
  const h = document.getElementById('siteHeader')?.getBoundingClientRect().height || 72;
  document.documentElement.style.setProperty('--hdr', h+'px');
}
setHeaderVar(); addEventListener('resize', setHeaderVar);

(async () => {
  const bust = `?t=${Date.now()}`;
  const getLocal = async (p) => {
    for (const u of [`/assets/${p}`, `assets/${p}`, `./assets/${p}`]) {
      try { const r = await fetch(u + bust, {cache:'no-store'}); if (r.ok) return r.json(); } catch {}
    } return null;
  };
  const norm = s => (s||"").toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]/g,"");
  const initials = team => team.split(/\s+/).filter(Boolean).map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const toHttps = url => (url||"").replace(/^http:\/\//i, "https://");

  /* Wikipedia page titles (crest fallback) */
  const WP_TITLE = {
    "Arsenal":"Arsenal_F.C.","Aston Villa":"Aston_Villa_F.C.","AFC Bournemouth":"AFC_Bournemouth","Brentford":"Brentford_F.C.",
    "Brighton and Hove Albion":"Brighton_&_Hove_Albion_F.C.","Burnley":"Burnley_F.C.","Chelsea":"Chelsea_F.C.",
    "Crystal Palace":"Crystal_Palace_F.C.","Everton":"Everton_F.C.","Fulham":"Fulham_F.C.","Leeds United":"Leeds_United_F.C.",
    "Liverpool":"Liverpool_F.C.","Manchester City":"Manchester_City_F.C.","Manchester United":"Manchester_United_F.C.",
    "Newcastle United":"Newcastle_United_F.C.","Nottingham Forest":"Nottingham_Forest_F.C.","Tottenham Hotspur":"Tottenham_Hotspur_F.C.",
    "West Ham United":"West_Ham_United_F.C.","Wolverhampton Wanderers":"Wolverhampton_Wanderers_F.C.","Sunderland":"Sunderland_A.F.C."
  };
  async function fetchWikiClubCrest(team){
    const title = WP_TITLE[team] || (team.replace(/\s+/g,'_') + "_F.C.");
    try{
      const r = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(title), {cache:'no-store'});
      if (!r.ok) return null;
      const j = await r.json();
      return toHttps(j?.originalimage?.source || j?.thumbnail?.source || null);
    }catch(e){ return null; }
  }

  /* ===== TABLE ===== */
  const [table, badgesFile] = await Promise.all([ getLocal('table.json'), getLocal('badges.json') ]);
  const tbody = document.getElementById("tableBody");
  const lu = document.getElementById("lastUpdated");

  const localBadges = {};
  if (badgesFile?.badges) for (const [k,v] of Object.entries(badgesFile.badges)) localBadges[norm(k)] = toHttps(v || "");

  function rowHTML(r){
    const b = toHttps(r.badge || localBadges[norm(r.team)]);
    const badge = b
      ? `<img class="badge img" referrerpolicy="no-referrer" src="${b}" alt="">`
      : `<span class="badge initials" data-team="${r.team}">${initials(r.team||'')}</span>`;
    return `
      <tr>
        <td>${r.pos ?? ""}</td>
        <td><span class="team-cell">${badge}${r.team ?? ""}</span></td>
        <td>${r.played ?? ""}</td><td>${r.won ?? ""}</td><td>${r.drawn ?? ""}</td><td>${r.lost ?? ""}</td>
        <td>${r.gf ?? ""}</td><td>${r.ga ?? ""}</td><td>${r.gd ?? ""}</td><td><strong>${r.pts ?? ""}</strong></td>
      </tr>`;
  }
  if (!table?.standings?.length) {
    tbody.innerHTML = '<tr><td colspan="10"><div class="muted">⚠️ No table data (check /assets/table.json).</div></td></tr>';
  } else {
    tbody.innerHTML = table.standings.map(rowHTML).join("");
    const updated = (await getLocal('update_stamp.txt')) || null; // optional
    if (lu) lu.textContent = "Last updated: " + new Date(table.updated || Date.now()).toLocaleString();
  }
  function upgradeFromMap(map){
    document.querySelectorAll('.badge.initials[data-team]').forEach(el=>{
      const nm = el.getAttribute('data-team') || '';
      const url = toHttps(map[norm(nm)]);
      if (url) {
        const img = new Image();
        img.className = 'badge img'; img.alt = ''; img.referrerPolicy = 'no-referrer';
        img.onload = () => el.replaceWith(img);
        img.src = url;
      }
    });
  }
  if (Object.keys(localBadges).length) upgradeFromMap(localBadges);
  async function upgradeWithWikiExact(){
    const els = Array.from(document.querySelectorAll('.badge.initials[data-team]'));
    if (!els.length) return;
    const chunk = async list => {
      const part = list.splice(0,6);
      await Promise.all(part.map(async el=>{
        const team = el.getAttribute('data-team') || '';
        const url  = await fetchWikiClubCrest(team);
        if (url){
          const img = new Image();
          img.className = 'badge img'; img.alt=''; img.referrerPolicy='no-referrer';
          img.onload = () => el.replaceWith(img);
          img.src = url;
        }
      }));
      if (list.length) await chunk(list);
    };
    await chunk(els);
  }
  await upgradeWithWikiExact();

  /* ===== FIXTURES & RESULTS ===== */
  const fixtures = await getLocal('fixtures.json');
  const wrap = document.getElementById("fixturesWrap");
  function t(s){ return new Date(s).getTime() || 0; }
  function fmtD(d){ return new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric', timeZone:'Europe/London' }); }
  function fmtT(d){ return new Date(d).toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Europe/London' }); }
  const isFinished = m => {
    const st = (m.status || "").toUpperCase();
    if (st === "FINISHED") return true;
    if (st === "SCHEDULED") return false;
    if (m.score && typeof m.score.home === "number" && typeof m.score.away === "number") return true;
    return t(m.date) < Date.now();
  };
  const cls = o => o === "W" ? "win" : o === "D" ? "draw" : o === "L" ? "loss" : "";

  if (!fixtures?.matches?.length) {
    wrap.innerHTML = '<div class="muted">⚠️ No fixtures data (check /assets/fixtures.json).</div>';
  } else {
    const all = fixtures.matches.slice().sort((a,b)=> t(a.date) - t(b.date));
    const upcoming = all.filter(m => !isFinished(m));
    const recent   = all.filter(isFinished).sort((a,b)=> t(b.date) - t(a.date)).slice(0, 10);

    const upHTML = `
      <h3 style="margin:8px 0;">Upcoming</h3>
      <table>
        <thead><tr><th>Date (UK)</th><th>Time (UK)</th><th>Comp</th><th>Home</th><th></th><th>Away</th><th>TV</th></tr></thead>
        <tbody>
        ${upcoming.map(m=>{
          const tv = (m.tv || '').replace(/;|,/g, ', ').trim() || 'TBD';
          return `<tr>
            <td>${fmtD(m.date)}</td>
            <td>${fmtT(m.date)}</td>
            <td><span class="pill">${m.comp||""}</span></td>
            <td>${m.home}</td><td>vs</td><td>${m.away}</td>
            <td>${tv}</td>
          </tr>`;
        }).join("") || `<tr><td colspan="7" class="muted">No upcoming fixtures.</td></tr>`}
        </tbody>
      </table>`;

    const recHTML = `
      <h3 style="margin:12px 0 6px;">Recent Results</h3>
      ${recent.map(m=>{
        const sc = m.score ? `${m.score.home}–${m.score.away}` : "";
        const oc = m.score?.outcome || "";
        const year = new Date(m.date).getFullYear();
        const q = encodeURIComponent(`${m.home} ${m.away} highlights ${year}`);
        const sky = `https://www.skysports.com/search?q=${q}`;
        const yt  = `https://www.youtube.com/results?search_query=${q}`;
        return `
          <div class="row-card ${cls(oc)}">
            <div style="display:grid;grid-template-columns:80px 60px 160px 1fr 1fr 60px 80px 100px;gap:8px;align-items:center">
              <div>${fmtD(m.date)}</div>
              <div>${fmtT(m.date)}</div>
              <div><span class="pill">${m.comp||""}</span></div>
              <div style="text-align:right">${m.home}</div>
              <div style="text-align:center">vs</div>
              <div style="text-align:left">${m.away}</div>
              <div><strong>${sc}</strong>${oc?` (${oc})`:""}</div>
              <div>
                <a class="pill" href="${sky}" target="_blank" rel="noopener noreferrer">Sky</a>
                <a class="pill" href="${yt}"  target="_blank" rel="noopener noreferrer" style="margin-left:6px;">YT</a>
              </div>
            </div>
          </div>`;
      }).join("")}
    `;
    wrap.innerHTML = upHTML + recHTML;
  }
})();

/* ===== F1 RESULTS (prefer local /assets/f1_results.json, fallback to live) ===== */
async function loadF1(){
  const wrap = document.getElementById('f1Wrap');
  const title = document.getElementById('f1Title');

  function render(data){
    const season = data?.season || new Date().getFullYear();
    if (title) title.textContent = `F1 — ${season} Results`;
    const races = data?.races || [];
    if (!races.length){
      wrap.innerHTML = '<div class="muted">No completed races yet.</div>';
      return;
    }
    const chip = (obj, cls) =>
      obj
        ? `<span class="driver-chip ${cls}"><span class="dot"></span><span>${obj.code}</span><span class="team">(${obj.team})</span></span>`
        : `<span class="muted">–</span>`;

    const rows = races.map(r=>{
      const [p1,p2,p3] = r.podium || [];
      const dt = new Date(r.date).toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
      return `<tr>
        <td>${dt}</td>
        <td style="text-align:left">${r.name}</td>
        <td>${chip(p1,'p1')}</td>
        <td>${chip(p2,'p2')}</td>
        <td>${chip(p3,'p3')}</td>
      </tr>`;
    }).join('');

    wrap.innerHTML = `
      <table>
        <thead>
          <tr><th style="min-width:70px">Date</th><th style="text-align:left">Grand Prix</th><th>P1</th><th>P2</th><th>P3</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  try{
    // Prefer local asset from GitHub Action
    const local = await (async () => {
      for (const p of ['/assets/f1_results.json','assets/f1_results.json','./assets/f1_results.json']){
        try { const r = await fetch(p + `?t=${Date.now()}`, {cache:'no-store'}); if (r.ok) return r.json(); } catch {}
      }
      return null;
    })();
    if (local?.races?.length){ render(local); return; }
  }catch(e){}

  // Fallback: live Ergast (if allowed)
  try{
    const r = await fetch('https://ergast.com/api/f1/current/results.json?limit=1000', {cache:'no-store'});
    if(!r.ok) throw 0;
    const j = await r.json();
    const races = j?.MRData?.RaceTable?.Races || [];
    const season = j?.MRData?.RaceTable?.season || new Date().getFullYear();
    const out = {season, races:[]};
    for (const rr of races){
      if (!Array.isArray(rr.Results) || rr.Results.length < 3) continue;
      const pick = n => {
        const found = rr.Results.find(x => String(x.position || x.positionText) === String(n));
        if (!found) return null;
        const d = found.Driver || {};
        const code = d.code || (d.familyName||'').slice(0,3).toUpperCase();
        return {code, team:(found.Constructor||{}).name||''};
      };
      out.races.push({date: rr.date, name: rr.raceName, podium:[pick(1),pick(2),pick(3)]});
    }
    render(out);
  }catch(e){
    console.error('F1 fetch failed', e);
    wrap.innerHTML = '<div class="muted">⚠️ Couldn’t load F1 results right now.</div>';
  }
}
loadF1();
</script>
</body>
</html>
