<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>thekeelan.co.uk</title>
  <meta name="theme-color" content="#0b0f14" />
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">

  <style>
    :root{
      --text:#e9eef5; --muted:#9aa6b2; --card:#12161b; --border:#1e242c; --accent:#6ee7ff; --accent2:#a78bfa;
      --hdr:72px;
      --bg:#0b0f14;
      --thead:#0f141a;
      --win:#10361f; --draw:#2b2b17; --loss:#3a1a1a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.80)),
        url('https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?auto=format&fit=crop&w=2400&q=60') center top / cover no-repeat fixed;
      background-color:var(--bg);
    }

    /* Header / menu */
    .site-header{
      position:sticky; top:0; z-index:30;
      display:flex; align-items:center; gap:12px; padding:10px 18px;
      backdrop-filter: blur(8px);
      background: rgba(11,15,20,0.6);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brand-logo{width:28px;height:28px;border-radius:6px;background:
      radial-gradient(circle at 30% 30%,#6ee7ff,transparent 40%),
      radial-gradient(circle at 70% 70%,#a78bfa,transparent 40%); box-shadow:0 0 0 1px #2a3340 inset}
    .brand h1{margin:0;font-size:18px}
    .spacer{flex:1}
    #lastUpdated{white-space:nowrap; color:var(--muted)}
    .nav{display:flex;gap:10px}
    .nav a{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px; color:var(--muted); text-decoration:none;
      transition:all .18s ease;
    }
    .nav a:hover{ color:var(--text); border-color:#2a3340; background:#0f141a }
    .nav a.active{
      color:var(--text);
      border-color:transparent;
      background: linear-gradient(90deg, rgba(110,231,255,.20), rgba(167,139,250,.20));
      box-shadow: 0 0 0 1px rgba(110,231,255,.25) inset;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1.6fr 1.2fr;
      gap:18px; padding:12px 18px 24px; align-items:start;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .card h2{margin:0 0 8px}
    .muted{color:var(--muted)}
    .stretch{display:flex;flex-direction:column;height:calc(100dvh - var(--hdr) - 24px);min-height:420px}
    .panel{border:1px solid var(--border);border-radius:10px;overflow:auto;flex:1;min-height:0}

    /* Tables */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:center}
    thead th{position:sticky;top:0;background:var(--thead);z-index:1}
    tr:hover td{background:#0f141a}

    .team-cell{display:flex;align-items:center;justify-content:flex-start;gap:8px}
    .badge{
      width:20px;height:20px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      background:#0f141a;
      font-weight:700;font-size:11px;letter-spacing:.5px
    }
    .badge.img{background:none}
    .badge.initials{
      background: radial-gradient(closest-side, #1a2430, #0f141a);
      border:1px solid #243041; color:#b6c2cf; text-transform:uppercase;
      min-width:20px;
    }

    .W td{background:var(--win)}
    .D td{background:var(--draw)}
    .L td{background:var(--loss)}
    a.btn{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:8px;font-size:12px}
    a.btn + .btn{margin-left:6px}
    img.resp{display:block;width:100%;height:auto;border-radius:10px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <header id="siteHeader" class="site-header">
    <div class="brand">
      <div class="brand-logo" aria-hidden="true"></div>
      <h1>thekeelan.co.uk</h1>
    </div>
    <div class="spacer"></div>
    <div id="lastUpdated">Last updated: —</div>
    <nav class="nav" aria-label="Primary">
      <a class="active" href="/" title="Football">Football</a>
      <a href="/extras.html" title="Extras">Extras</a>
    </nav>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section class="card stretch">
      <h2>Left Panel</h2>
      <img class="resp"
        src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExcThlOWlqcmc5YnZmcTVtaDByZHdpZHd4cWo4YTl0NXB4NGlxNnFlaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/yRl0DstAx4nN0RjDLV/giphy.gif"
        alt="gif">
    </section>

    <!-- CENTRE -->
    <section class="card" style="align-self:start;height:max-content;">
      <h2>Premier League Table</h2>
      <div style="border:1px solid var(--border);border-radius:10px;overflow:auto;">
        <table>
          <thead>
            <tr><th>#</th><th style="text-align:left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="10" class="muted">Waiting for data…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card stretch">
      <h2>Man United – Fixtures & Results</h2>
      <div class="panel" style="padding:8px;">
        <div id="fixturesWrap" class="muted">Waiting for data…</div>
      </div>
    </section>
  </div>

  <script>
  // Keep left/right cards sized nicely below header
  function setHeaderVar(){
    const h = document.getElementById('siteHeader')?.getBoundingClientRect().height || 72;
    document.documentElement.style.setProperty('--hdr', h+'px');
  }
  setHeaderVar(); addEventListener('resize', setHeaderVar);

  (async () => {
    const bust = `?t=${Date.now()}`;
    const tryJson = async (path) => {
      for (const base of ["", "/"]) {
        const url = `${base}${path}${bust}`;
        try { const r = await fetch(url, {cache:'no-store'}); if (r.ok) return r.json(); } catch {}
      }
      return null;
    };
    const tryText = async (path) => {
      for (const base of ["", "/"]) {
        const url = `${base}${path}${bust}`;
        try { const r = await fetch(url, {cache:'no-store'}); if (r.ok) return r.text(); } catch {}
      }
      return null;
    };

    const norm = s => (s||"").toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]/g,"");
    const toHttps = u => (u||"").replace(/^http:\/\//i, "https://");
    const initials = team => (team||"").split(/\s+/).filter(Boolean).map(w=>w[0]).slice(0,2).join('').toUpperCase();

    /* ===== Last updated ===== */
    const lu = document.getElementById("lastUpdated");
    let stamp = await tryText("assets/update_stamp.txt");
    if (!stamp) {
      const tableProbe = await tryJson("assets/table.json");
      if (tableProbe?.updated) stamp = new Date(tableProbe.updated).toISOString();
    }
    if (stamp && lu) lu.textContent = "Last updated: " + stamp.replace("T"," ").replace("Z","Z");

    /* ===== TABLE + BADGES ===== */
    const [table, badgesFile] = await Promise.all([
      tryJson("assets/table.json"),
      tryJson("assets/badges.json"),
    ]);
    const tbody = document.getElementById("tableBody");

    const badgeMap = {};
    if (badgesFile?.badges) {
      for (const [k,v] of Object.entries(badgesFile.badges)) badgeMap[norm(k)] = toHttps(v||"");
    }

    function rowHTML(r){
      const badgeURL = toHttps(r.badge || badgeMap[norm(r.team)]);
      const badgeEl = badgeURL
        ? `<img class="badge img" referrerpolicy="no-referrer" src="${badgeURL}" alt="">`
        : `<span class="badge initials" data-team="${r.team}">${initials(r.team)}</span>`;
      return `
        <tr>
          <td>${r.pos ?? ""}</td>
          <td style="text-align:left"><span class="team-cell">${badgeEl}${r.team ?? ""}</span></td>
          <td>${r.played ?? ""}</td><td>${r.won ?? ""}</td><td>${r.drawn ?? ""}</td><td>${r.lost ?? ""}</td>
          <td>${r.gf ?? ""}</td><td>${r.ga ?? ""}</td><td>${r.gd ?? ""}</td><td><strong>${r.pts ?? ""}</strong></td>
        </tr>`;
    }

    if (!table?.standings?.length) {
      tbody.innerHTML = '<tr><td colspan="10" class="muted">⚠️ No table data (check /assets/table.json).</td></tr>';
    } else {
      // Always render everything we have (should be 20 from ESPN/TSDB workflow)
      tbody.innerHTML = table.standings.map(rowHTML).join("");
    }

    /* ===== FIXTURES – hard lock to MU ===== */
    const fx = await tryJson("assets/fixtures.json");
    const wrap = document.getElementById("fixturesWrap");
    if (!fx?.matches?.length) {
      wrap.innerHTML = '<div class="muted">⚠️ No fixtures data (check /assets/fixtures.json).</div>';
    } else {
      const teamName = (fx.team || "Manchester United").toLowerCase();
      const t = s => new Date(s).getTime() || 0;

      // Safety: filter to MU only (prevents any Bolton shenanigans)
      const safeMatches = fx.matches.filter(m =>
        ((m.home||"").toLowerCase() === teamName) || ((m.away||"").toLowerCase() === teamName)
      ).sort((a,b)=> t(a.date) - t(b.date));

      const isFinished = m => {
        const st = (m.status||"").toUpperCase();
        if (st === "FINISHED") return true;
        if (st === "SCHEDULED") return false;
        if (m.score && typeof m.score.home === "number" && typeof m.score.away === "number") return true;
        return t(m.date) < Date.now();
      };
      const fmtD = d => new Date(d).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric', timeZone:'Europe/London' });
      const fmtT = d => new Date(d).toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Europe/London' });
      const cls  = o => o === "W" ? "W" : o === "D" ? "D" : o === "L" ? "L" : "";

      const upcoming = safeMatches.filter(m => !isFinished(m)).slice(0,8);
      const recent   = safeMatches.filter(isFinished).sort((a,b)=> t(b.date) - t(a.date)).slice(0,8);

      function guessUkTv(dateStr, comp) {
        const dt = new Date(dateStr);
        const day = dt.toLocaleString('en-GB', { weekday:'short', timeZone:'Europe/London' });
        const hm  = dt.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Europe/London' });
        if (!/premier/i.test(comp||"")) return null;
        if (day === 'Sat' && hm === '12:30') return 'TNT Sports (est.)';
        if (day === 'Sat' && (hm === '17:30' || hm === '20:00')) return 'Sky Sports (est.)';
        if (day === 'Sun' && (hm === '14:00' || hm === '16:30' || hm === '19:00')) return 'Sky Sports (est.)';
        if ((day === 'Mon' || day === 'Fri') && (hm === '19:45' || hm === '20:00')) return 'Sky Sports (est.)';
        return 'TBD';
      }

      const upHTML = `
        <h3 style="margin:8px 0;">Upcoming</h3>
        <table>
          <thead><tr>
            <th>Date (UK)</th><th>Time (UK)</th><th>Comp</th>
            <th>Home</th><th></th><th>Away</th><th>TV (UK)</th>
          </tr></thead>
          <tbody>
            ${upcoming.length ? upcoming.map(m => {
              const tv = (m.tv||'').trim() || guessUkTv(m.date, m.comp) || '';
              return `<tr>
                <td>${fmtD(m.date)}</td><td>${fmtT(m.date)}</td>
                <td>${m.comp||""}</td><td>${m.home}</td><td>vs</td><td>${m.away}</td>
                <td>${tv}</td>
              </tr>`;
            }).join("") : `<tr><td colspan="7" class="muted">No upcoming fixtures.</td></tr>`}
          </tbody>
        </table>`;

      const recHTML = `
        <h3 style="margin:12px 0 6px;">Recent Results</h3>
        <table>
          <thead><tr>
            <th>Date</th><th>Comp</th><th>Home</th><th></th><th>Away</th><th>Score</th><th>Highlights</th>
          </tr></thead>
          <tbody>
            ${recent.length ? recent.map(m=>{
              const sc = m.score ? `${m.score.home}–${m.score.away}` : "";
              const oc = m.score?.outcome || "";
              const year = new Date(m.date).getFullYear();
              const q = encodeURIComponent(`${m.home} ${m.away} highlights ${year}`);
              const sky = `https://www.skysports.com/search?q=${q}`;
              const yt  = `https://www.youtube.com/results?search_query=${q}`;
              return `<tr class="${cls(oc)}">
                <td>${fmtD(m.date)}</td>
                <td>${m.comp||""}</td>
                <td>${m.home}</td><td>vs</td><td>${m.away}</td>
                <td><strong>${sc}</strong>${oc?` (${oc})`:""}</td>
                <td>
                  <a class="btn" href="${sky}" target="_blank" rel="noopener noreferrer">Sky</a>
                  <a class="btn" href="${yt}"  target="_blank" rel="noopener noreferrer">YT</a>
                </td>
              </tr>`;
            }).join("") : `<tr><td colspan="7" class="muted">No recent results.</td></tr>`}
          </tbody>
        </table>`;

      wrap.innerHTML = upHTML + recHTML;
    }
  })();
  </script>
</body>
</html>
