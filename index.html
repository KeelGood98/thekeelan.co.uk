<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Mum</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#141a22; --text:#e9eef5; --muted:#95a1b1;
      --stroke:rgba(255,255,255,.09); --accent:#3aa0ff;
      --w:#1ec178; --d:#c7ccd4; --l:#ff5b5b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1600px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);display:inline-block;box-shadow:0 0 16px var(--accent)}
    nav{display:flex;gap:8px}
    nav a{padding:8px 12px;border:1px solid var(--stroke);border-radius:999px;opacity:.92}
    nav a.active{background:var(--accent);border-color:transparent;color:#04121f;font-weight:600}

    .grid{display:grid;grid-template-columns:minmax(340px,380px) 1.6fr 1.2fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--stroke);font-size:20px}
    .card-body{padding:14px 16px}
    .gif{width:100%;display:block}

    table{width:100%;border-collapse:collapse}
    tbody{display:table-row-group !important}
    th,td{padding:10px 8px;text-align:center;font-size:14px}
    th{text-transform:uppercase;letter-spacing:.06em;font-size:12px;color:var(--muted)}
    tbody tr{border-top:1px solid var(--stroke)}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    td.team{text-align:left;display:flex;align-items:center;gap:10px}
    .badge{width:20px;height:20px;border-radius:50%;display:inline-grid;place-items:center;background:#0f1319;border:1px solid var(--stroke);overflow:hidden}
    .badge img{width:100%;height:100%;object-fit:contain}
    .badge span{font-size:10px;color:var(--muted);font-weight:700}

    .fx-head{display:flex;justify-content:space-between;align-items:center;padding:0 16px 10px 16px}
    .subtle{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;color:var(--muted)}
    .w{color:var(--w)} .d{color:var(--d)} .l{color:var(--l)}
    .fixture-table th, .fixture-table td{padding:8px}
    .fixture-table th{font-size:11px}
    .fixture-table td{font-size:14px}
    .divider{height:1px;background:var(--stroke);margin:10px 0}

    body::after{
      content:"";position:fixed;inset:0;pointer-events:none;
      background:
        radial-gradient(1200px 600px at 65% 85%, rgba(58,160,255,.08), transparent 60%),
        radial-gradient(900px 500px at 20% 10%, rgba(255,255,255,.05), transparent 60%);
      mix-blend-mode:screen;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><span class="dot"></span> thekeelan.co.uk</div>
      <nav>
        <a class="active" href="./">Football</a>
        <a href="./extras.html">Extras</a>
      </nav>
    </header>

    <div class="grid">
      <!-- LEFT: GIF -->
      <div class="card">
        <h2>Left Panel</h2>
        <img class="gif" src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExcThlOWlqcmc5YnZmcTVtaDByZHdpZHd4cWo4YTl0NXB4NGlxNnFlaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/yRl0DstAx4nN0RjDLV/giphy.gif" alt="gif" />
      </div>

      <!-- MIDDLE: Table -->
      <div class="card" id="table-card">
        <div class="fx-head" style="padding-top:14px">
          <h2 style="border:none;padding:0">Premier League Table</h2>
          <div class="subtle" id="tableStamp"></div>
        </div>
        <div class="subtle" id="tableNote" style="padding:0 16px 6px 16px;"></div>
        <table id="pl-table" aria-label="Premier League Table">
          <thead>
            <tr>
              <th>#</th><th style="text-align:left">Team</th>
              <th>P</</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- RIGHT: Fixtures -->
      <div class="card" id="fx-card">
        <div class="fx-head">
          <h2 style="border:none;padding:0">Man United – Fixtures &amp; Results</h2>
          <div class="subtle" id="updatedStamp">—</div>
        </div>

        <div class="card-body">
          <h3 style="margin:0 0 6px 0;">Upcoming</h3>
          <table class="fixture-table" id="fx-upcoming">
            <thead>
              <tr>
                <th>Date (UK)</th><th>Time (UK)</th><th>Comp</th><th>Home</th><th></th><th>Away</th><th>TV (UK)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="divider"></div>

          <h3 style="margin:10px 0 6px 0;">Recent Results</h3>
          <table class="fixture-table" id="fx-recent">
            <thead>
              <tr>
                <th>Date</th><th>Comp</th><th>Home</th><th></th><th>Away</th><th>Score</th><th>Highlights</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const bust = () => `?t=${Date.now()}`;
    const el = s => document.querySelector(s);
    const tb = s => el(s).querySelector("tbody");
    const toDate = v => { const d = new Date(v); return isNaN(d) ? null : d; };
    const fmtDate = v => { const d = toDate(v); return d ? d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}) : "—"; };
    const fmtTime = v => { const d = toDate(v); return d ? d.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}) : "—"; };
    const initials = name => {
      const p = (name||"").split(/\s+/).filter(Boolean);
      if (!p.length) return "FC";
      return (p[0][0] + (p[p.length-1]?.[0]||"")).toUpperCase();
    };
    async function getJSON(path){ try{ const r=await fetch(path + bust()); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
    async function getText(path){ try{ const r=await fetch(path + bust()); if(!r.ok) return null; return await r.text(); }catch{ return null; } }

    // ---------- tolerant badge matching ----------
    const normName = s => (s||"").toLowerCase()
      .replace(/\bfc\b/g,"")
      .replace(/&/g,"and")
      .replace(/[.'’\-]/g,"")
      .replace(/\s+/g," ")
      .trim();

    function getBadgeSrc(badgesObj, teamName){
      if (!badgesObj) return null;
      // accept either { "Team": "url" } or { "badges": { "Team": "url" } }
      const bag = badgesObj.badges || badgesObj;
      if (!bag || typeof bag!=="object") return null;
      if (bag[teamName]) return bag[teamName];
      if (!getBadgeSrc._cache){
        const c = new Map();
        for (const [k,v] of Object.entries(bag)){ c.set(normName(k), v); }
        getBadgeSrc._cache = c;
      }
      return getBadgeSrc._cache.get(normName(teamName)) || null;
    }

    // ---------- deep array finder for table ----------
    function looksLikeTableRow(o){
      if (!o || typeof o!=="object") return false;
      const t = (o.team || o.teamName || o.name || (o.team?.name));
      const hasPos = ("pos" in o) || ("position" in o) || ("rank" in o);
      const hasPts = ("pts" in o) || ("points" in o) || ("total" in o);
      return !!t && (hasPos || hasPts);
    }
    function collectArrays(obj, out=[]){
      if (!obj || typeof obj!=="object") return out;
      if (Array.isArray(obj)){ out.push(obj); return out; }
      for (const k in obj) collectArrays(obj[k], out);
      return out;
    }
    function pickBestTableArray(obj){
      const arrays = collectArrays(obj, []);
      const scored = arrays.map(a=>{
        const like = a.filter(looksLikeTableRow).length;
        return {a, score:like*100 + a.length};
      }).sort((x,y)=>y.score-x.score);
      return scored.length ? scored[0].a : [];
    }
    function mapTableRow(r){
      const teamName = r.team || r.teamName || r.name || (r.team?.name) || "";
      const played = r.played ?? r.playedGames ?? r.p;
      const won = r.won ?? r.w;
      const drawn = r.drawn ?? r.d;
      const lost = r.lost ?? r.l;
      const gf = r.gf ?? r.goalsFor ?? r.f ?? r.goalsfor;
      const ga = r.ga ?? r.goalsAgainst ?? r.a ?? r.goalsagainst;
      const gd = (r.gd!==undefined) ? r.gd : ( (gf!=null && ga!=null) ? (gf-ga) : "" );
      const pos = r.pos ?? r.position ?? r.rank ?? "";
      const pts = r.pts ?? r.points ?? r.total ?? "";
      return { pos, team: teamName, played, won, drawn, lost, gf, ga, gd, pts };
    }

    // ---------- fixtures normaliser tuned to your current file ----------
    function normaliseMatch(m){
      // your file has these exact fields
      const date = m.date;
      const hn = m.home || m.homeTeam || "";
      const an = m.away || m.awayTeam || "";
      const comp = m.comp || m.competition || m.strLeague || "";
      const tv   = m.tv || m.tv_uk || m.channel || null;

      // score: { home, away, outcome } already present
      let homeS = (m.score && m.score.home !== undefined && m.score.home !== "") ? Number(m.score.home) : "";
      let awayS = (m.score && m.score.away !== undefined && m.score.away !== "") ? Number(m.score.away) : "";
      let outcome = (m.score && m.score.outcome) ? String(m.score.outcome).toLowerCase() : "";

      const status = String(m.status||"").toUpperCase();
      const finished = status==="FINISHED" || (homeS!=="" && awayS!=="");
      if (!outcome && finished && homeS!=="" && awayS!==""){
        outcome = homeS===awayS ? "d" : (homeS>awayS ? "w" : "l");
      }
      return { date, comp, home: hn, away: an, tv, score:{home:homeS, away:awayS, outcome}, finished, highlights:m.highlights||{} };
    }

    function tvOverride(match, overrides){
      if (!overrides) return null;
      const day = (match.date||"").slice(0,10);
      const hit = overrides.find(o=>{
        const okDay = o.date ? o.date===day : true;
        const sameH = o.home ? o.home.toLowerCase()===(match.home||"").toLowerCase() : true;
        const sameA = o.away ? o.away.toLowerCase()===(match.away||"").toLowerCase() : true;
        return okDay && sameH && sameA;
      });
      return hit?.tv || null;
    }

    // ---------- render table ----------
    async function renderTable(){
      const [table, badgesJson] = await Promise.all([
        getJSON("/assets/table.json"),
        getJSON("/assets/badges.json")
      ]);

      const body = tb("#pl-table"); body.innerHTML = "";

      if (!table){
        el("#tableNote").textContent = "table.json missing/invalid.";
        return 0;
      }

      const rawRows = table?.standings || table?.table || table?.rows || table?.data || pickBestTableArray(table) || [];
      const rows = (Array.isArray(rawRows) ? rawRows : []).map(mapTableRow);

      // small hint if data is truncated
      el("#tableNote").textContent = rows.length < 10
        ? `Note: table source returned only ${rows.length} rows (check /assets/table.json).`
        : (badgesJson ? "" : "Badges note: badges.json missing/invalid.");

      rows.forEach(r=>{
        const src = getBadgeSrc(badgesJson, r.team);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.pos ?? ""}</td>
          <td class="team">
            <span class="badge">${src ? `<img src="${src}" alt="${r.team} badge">` : `<span>${initials(r.team)}</span>`}</span>
            <span>${r.team}</span>
          </td>
          <td>${r.played ?? ""}</td>
          <td>${r.won ?? ""}</td>
          <td>${r.drawn ?? ""}</td>
          <td>${r.lost ?? ""}</td>
          <td>${r.gf ?? ""}</td>
          <td>${r.ga ?? ""}</td>
          <td>${r.gd ?? ""}</td>
          <td>${r.pts ?? ""}</td>
        `;
        body.appendChild(tr);
      });

      let tableUpdated = table?.updated || table?.lastUpdated || table?.meta?.updated || 0;
      if (tableUpdated){
        const d = new Date(tableUpdated);
        if (!isNaN(d)) el("#tableStamp").textContent = `Updated: ${d.toLocaleString("en-GB")}`;
      }
      return Number(tableUpdated||0);
    }

    // ---------- render fixtures (uses your current shape) ----------
    async function renderFixtures(){
      const [fx, overrides] = await Promise.all([
        getJSON("/assets/fixtures.json"),
        getJSON("/assets/tv_overrides.json")
      ]);

      const upTB = tb("#fx-upcoming");
      const rcTB = tb("#fx-recent");

      if (!fx || !Array.isArray(fx.matches)){
        upTB.innerHTML = `<tr><td colspan="7" class="subtle">fixtures.json missing/invalid.</td></tr>`;
        rcTB.innerHTML = `<tr><td colspan="7" class="subtle">fixtures.json missing/invalid.</td></tr>`;
        return Number(fx?.updated||0);
      }

      const norm = fx.matches.map(normaliseMatch);

      const upcoming = norm.filter(m=>!m.finished).sort((a,b)=> new Date(a.date)-new Date(b.date)).slice(0,8);
      const recent   = norm.filter(m=> m.finished).sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,8);

      upTB.innerHTML = upcoming.length ? "" : `<tr><td colspan="7" class="subtle">No upcoming fixtures.</td></tr>`;
      upcoming.forEach(m=>{
        const tv = m.tv || tvOverride(m, overrides) || "—";
        upTB.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${fmtDate(m.date)}</td>
            <td>${fmtTime(m.date)}</td>
            <td>${m.comp ?? ""}</td>
            <td>${m.home ?? ""}</td>
            <td>vs</td>
            <td>${m.away ?? ""}</td>
            <td>${tv}</td>
          </tr>
        `);
      });

      rcTB.innerHTML = recent.length ? "" : `<tr><td colspan="7" class="subtle">No recent matches.</td></tr>`;
      recent.forEach(m=>{
        const oc = (m.score?.outcome || "").toLowerCase();
        const ocLabel = oc ? `<span class="${oc} pill">${oc.toUpperCase()}</span>` : "";
        const scoreTxt = (m.score && m.score.home!=="") ? `${m.score.home}–${m.score.away}` : "—";
        rcTB.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${fmtDate(m.date)}</td>
            <td>${m.comp ?? ""}</td>
            <td>${m.home ?? ""}</td>
            <td>vs</td>
            <td>${m.away ?? ""}</td>
            <td>${scoreTxt} ${ocLabel}</td>
            <td>
              ${m.highlights?.sky ? `<a class="pill" href="${m.highlights.sky}" target="_blank" rel="noopener">Sky</a>` : ""}
              ${m.highlights?.yt  ? `<a class="pill" href="${m.highlights.yt}"  target="_blank" rel="noopener">YT</a>`  : ""}
            </td>
          </tr>
        `);
      });

      let fxUpdated = fx?.updated || fx?.lastUpdated || 0;
      return Number(fxUpdated||0);
    }

    async function loadPage(){
      const [tU, fU] = await Promise.all([renderTable(), renderFixtures()]);
      let stamp = Math.max(Number(tU||0), Number(fU||0));
      if (!stamp){
        const txt = await getText("/assets/update_stamp.txt");
        if (txt){
          const d = new Date(txt.trim());
          if (!isNaN(d)) stamp = d.getTime();
        }
      }
      if (stamp){
        const d = new Date(stamp);
        el("#updatedStamp").textContent = `Last updated: ${d.toLocaleString("en-GB")}`;
      }
    }
    loadPage();
  </script>
</body>
</html>
