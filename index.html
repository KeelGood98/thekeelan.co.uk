<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>thekeelan.co.uk</title>
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --text:#e9eef5; --muted:#9aa6b2; --card:#12161b; --border:#1e242c; --accent:#6ee7ff; --accent2:#a78bfa;
      --hdr:72px;
      --win:#0d2f1b; --draw:#2a2a14; --loss:#361616;
      --winEdge:#144929; --drawEdge:#494927; --lossEdge:#5a2323;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.80)),
        url('https://images.unsplash.com/photo-1517927033932-b3d18e61fb3a?auto=format&fit=crop&w=2400&q=60') center top / cover no-repeat fixed;
      background-color:#0b0f14;
    }

    /* Header / nav */
    .site-header{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:12px; padding:10px 18px;
      backdrop-filter: blur(8px);
      background: rgba(11,15,20,0.6);
      border-bottom: 1px solid var(--border);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .brand-logo{width:28px;height:28px;border-radius:6px;background:
      radial-gradient(circle at 30% 30%,#6ee7ff,transparent 40%),
      radial-gradient(circle at 70% 70%,#a78bfa,transparent 40%); box-shadow:0 0 0 1px #2a3340 inset}
    .brand h1{margin:0;font-size:18px}
    .spacer{flex:1}
    .nav{display:flex;gap:8px}
    .nav a{padding:6px 10px;border:1px solid var(--border);border-radius:999px;text-decoration:none;color:var(--muted)}
    .nav a.active{color:var(--text);background:linear-gradient(90deg, rgba(110,231,255,.18), rgba(167,139,250,.18));border-color:transparent}

    /* Layout */
    .grid{
      display:grid; grid-template-columns:1fr 1.6fr 1.2fr; gap:18px; padding:12px 18px 24px; align-items:start;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:1fr 1fr} }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .card h2{margin:0 0 8px}
    .muted{color:var(--muted)}
    .stretch{display:flex;flex-direction:column;height:calc(100dvh - var(--hdr) - 24px);min-height:420px}
    .panel{border:1px solid var(--border);border-radius:10px;overflow:auto;flex:1;min-height:0}

    /* Table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:center}
    thead th{position:sticky;top:0;background:#0f141a;z-index:1}
    tr:hover td{background:#0f141a}

    .team-cell{display:flex;align-items:center;justify-content:center;gap:8px}
    .badge{width:20px;height:20px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#0f141a;font-weight:700;font-size:11px;letter-spacing:.5px}
    .badge.img{background:none}
    .badge.initials{background: radial-gradient(closest-side, #1a2430, #0f141a); border:1px solid #243041; color:#b6c2cf; text-transform:uppercase}

    /* Fixtures look & feel */
    .fixturesWrap{display:flex;flex-direction:column;gap:14px}
    .sectionTitle{margin:6px 0 2px;font-weight:600;color:#d7dde6}
    .fxTable{width:100%;border-collapse:separate;border-spacing:0 8px}
    .fxRow{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .fxCell{padding:10px 12px;border-bottom:none;text-align:left}
    .fxRow .tv{white-space:nowrap}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    .linkbtn{display:inline-block;padding:2px 6px;border:1px solid var(--border);border-radius:6px;font-size:12px;text-decoration:none;color:#cfe7ff}
    .linkbtn + .linkbtn{margin-left:6px}

    /* Result colours */
    .fxRow.W   { background:linear-gradient(180deg, var(--win), rgba(0,0,0,0)); box-shadow:0 0 0 1px var(--winEdge) inset }
    .fxRow.D   { background:linear-gradient(180deg, var(--draw), rgba(0,0,0,0)); box-shadow:0 0 0 1px var(--drawEdge) inset }
    .fxRow.L   { background:linear-gradient(180deg, var(--loss), rgba(0,0,0,0)); box-shadow:0 0 0 1px var(--lossEdge) inset }

    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header id="siteHeader" class="site-header">
    <div class="brand">
      <div class="brand-logo" aria-hidden="true"></div>
      <h1>thekeelan.co.uk</h1>
    </div>
    <div class="spacer"></div>
    <div class="muted" id="lastUpdated">Last updated: —</div>
    <nav class="nav">
      <a class="active" href="/">Football</a>
      <a href="/extras.html">Extras</a>
    </nav>
  </header>

  <div class="grid">
    <!-- Left -->
    <section class="card stretch">
      <h2>Left Panel</h2>
      <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
        <img src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExcThlOWlqcmc5YnZmcTVtaDByZHdpZHd4cWo4YTl0NXB4NGlxNnFlaSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/yRl0DstAx4nN0RjDLV/giphy.gif" alt="gif" style="display:block;width:100%;height:auto;">
      </div>
    </section>

    <!-- Centre: Table -->
    <section class="card" style="align-self:start;height:max-content;">
      <h2>Premier League Table</h2>
      <div style="border:1px solid var(--border);border-radius:10px;overflow:auto;">
        <table>
          <thead>
          <tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="10" class="muted">Waiting for data…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Right: Fixtures -->
    <section class="card stretch">
      <h2>Man United – Fixtures & Results</h2>
      <div id="fixturesWrap" class="panel" style="padding:10px;">
        <div class="muted">Waiting for data…</div>
      </div>
    </section>
  </div>

<script>
(function(){
  const bust = `?t=${Date.now()}`;
  const getLocal = async (p) => {
    for (const u of [`/assets/${p}`, `assets/${p}`, `./assets/${p}`]) {
      try { const r = await fetch(u + bust, {cache:'no-store'}); if (r.ok) return r.json(); } catch {}
    } return null;
  };
  const norm = s => (s||"").toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]/g,"");
  const initials = team => team.split(/\s+/).filter(Boolean).map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const toHttps = url => (url||"").replace(/^http:\/\//i, "https://");

  /* ============ TABLE + BADGES (unchanged logic) ============ */
  const WP_TITLE = {
    "Arsenal":"Arsenal_F.C.","Aston Villa":"Aston_Villa_F.C.","Bournemouth":"AFC_Bournemouth",
    "Brentford":"Brentford_F.C.","Brighton and Hove Albion":"Brighton_&_Hove_Albion_F.C.","Burnley":"Burnley_F.C.",
    "Chelsea":"Chelsea_F.C.","Crystal Palace":"Crystal_Palace_F.C.","Everton":"Everton_F.C.","Fulham":"Fulham_F.C.",
    "Leeds United":"Leeds_United_F.C.","Liverpool":"Liverpool_F.C.","Manchester City":"Manchester_City_F.C.",
    "Manchester United":"Manchester_United_F.C.","Newcastle United":"Newcastle_United_F.C.",
    "Nottingham Forest":"Nottingham_Forest_F.C.","Tottenham Hotspur":"Tottenham_Hotspur_F.C.",
    "West Ham United":"West_Ham_United_F.C.","Wolverhampton Wanderers":"Wolverhampton_Wanderers_F.C.",
    "Sunderland":"Sunderland_A.F.C."
  };
  async function fetchWikiClubCrest(team){
    const title = WP_TITLE[team] || (team.replace(/\s+/g,'_') + "_F.C.");
    try{
      const r = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(title), {cache:'no-store'});
      if (!r.ok) return null;
      const j = await r.json();
      return toHttps(j?.originalimage?.source || j?.thumbnail?.source || null);
    }catch(e){ return null; }
  }
  function rowHTML(r, localBadges){
    const b = toHttps(r.badge || localBadges[norm(r.team)]);
    const badge = b
      ? `<img class="badge img" referrerpolicy="no-referrer" src="${b}" alt="">`
      : `<span class="badge initials" data-team="${r.team}">${initials(r.team||'')}</span>`;
    return `
      <tr>
        <td>${r.pos ?? ""}</td>
        <td><span class="team-cell">${badge}${r.team ?? ""}</span></td>
        <td>${r.played ?? ""}</td><td>${r.won ?? ""}</td><td>${r.drawn ?? ""}</td><td>${r.lost ?? ""}</td>
        <td>${r.gf ?? ""}</td><td>${r.ga ?? ""}</td><td>${r.gd ?? ""}</td><td><strong>${r.pts ?? ""}</strong></td>
      </tr>`;
  }
  function upgradeFromMap(map){
    document.querySelectorAll('.badge.initials[data-team]').forEach(el=>{
      const nm = el.getAttribute('data-team') || '';
      const url = toHttps(map[norm(nm)]);
      if (url) {
        const img = new Image();
        img.className = 'badge img'; img.alt=''; img.referrerPolicy='no-referrer';
        img.onload = () => el.replaceWith(img);
        img.src = url;
      }
    });
  }

  /* load table + badges */
  (async () => {
    const [table, badgesFile] = await Promise.all([ getLocal('table.json'), getLocal('badges.json') ]);
    const tbody = document.getElementById("tableBody");
    const lu = document.getElementById("lastUpdated");

    const localBadges = {};
    if (badgesFile?.badges) for (const [k,v] of Object.entries(badgesFile.badges)) localBadges[norm(k)] = toHttps(v || "");

    if (!table?.standings?.length) {
      tbody.innerHTML = '<tr><td colspan="10"><div class="muted">⚠️ No table data (check /assets/table.json).</div></td></tr>';
    } else {
      tbody.innerHTML = table.standings.map(r => rowHTML(r, localBadges)).join("");
      if (lu) lu.textContent = "Last updated: " + new Date(table.updated || Date.now()).toLocaleString();
    }

    if (Object.keys(localBadges).length) upgradeFromMap(localBadges);

    // Try TSDB club badges then Wiki fallback for any remaining initials
    async function fetchTSDBLeagueMap(){
      const out = {...localBadges};
      try {
        const r1 = await fetch('https://www.thesportsdb.com/api/v1/json/3/search_all_teams.php?l=English%20Premier%20League', {cache:'no-store'});
        if (r1.ok) (await r1.json())?.teams?.forEach(t => out[norm(t.strTeam)] = toHttps(t.strTeamBadge||""));
      } catch(e){}
      try {
        const r2 = await fetch('https://www.thesportsdb.com/api/v1/json/3/lookup_all_teams.php?id=4328', {cache:'no-store'});
        if (r2.ok) (await r2.json())?.teams?.forEach(t => out[norm(t.strTeam)] = toHttps(t.strTeamBadge||""));
      } catch(e){}
      return out;
    }
    const leagueMap = await fetchTSDBLeagueMap();
    upgradeFromMap(leagueMap);

    const els = Array.from(document.querySelectorAll('.badge.initials[data-team]'));
    if (els.length){
      const chunk = async list => {
        const part = list.splice(0,6);
        await Promise.all(part.map(async el=>{
          const url = await fetchWikiClubCrest(el.getAttribute('data-team')||'');
          if (url){ const img = new Image(); img.className='badge img'; img.alt=''; img.referrerPolicy='no-referrer';
            img.onload = () => el.replaceWith(img); img.src = url; }
        }));
        if (list.length) await chunk(list);
      };
      await chunk(els);
    }
  })();

  /* ============ FIXTURES (nicer view + W/D/L colours) ============ */
  (async () => {
    const fx = await getLocal('fixtures.json');
    const wrap = document.getElementById('fixturesWrap');
    if (!fx?.matches?.length){
      wrap.innerHTML = '<div class="muted">⚠️ No fixtures data (check /assets/fixtures.json).</div>';
      return;
    }

    const tz = 'Europe/London';
    const fmtDate = d => new Date(d).toLocaleDateString('en-GB',{ day:'2-digit', month:'short', year:'numeric', timeZone:tz });
    const fmtTime = d => new Date(d).toLocaleTimeString('en-GB',{ hour:'2-digit', minute:'2-digit', hour12:false, timeZone:tz });

    const byTime = fx.matches.slice().sort((a,b)=> (new Date(a.date)) - (new Date(b.date)));

    // Decide upcoming vs recent robustly:
    const isFinished = m => {
      const st = (m.state||m.status||"").toString().toLowerCase();
      if (st === 'post') return true;
      if (m.score && Number.isInteger(m.score.home) && Number.isInteger(m.score.away)) return true;
      return (new Date(m.date)) < new Date();
    };
    const recent = byTime.filter(isFinished).sort((a,b)=> (new Date(b.date)) - (new Date(a.date))).slice(0,8);
    const upcoming = byTime.filter(m => !isFinished(m)).slice(0,8);

    // Helper to render a row
    function row(m, showScore) {
      // outcome class (W/D/L)
      let cls = '';
      if (m.score?.outcome) cls = m.score.outcome;
      else if (Number.isInteger(m.score?.home) && Number.isInteger(m.score?.away)){
        // fallback outcome if script didn't include one
        const h = m.score.home, a = m.score.away;
        if (m.home?.toLowerCase().includes('manchester united')) cls = h>a?'W':(h===a?'D':'L');
        else if (m.away?.toLowerCase().includes('manchester united')) cls = a>h?'W':(a===h?'D':'L');
      }

      const tvRaw = (m.tv||'').replace(/;|,/g, ', ').trim();
      const year = new Date(m.date).getFullYear();
      const q = encodeURIComponent(`${m.home} ${m.away} highlights ${year}`);
      const sky = `https://www.skysports.com/search?q=${q}`;
      const yt  = `https://www.youtube.com/results?search_query=${q}`;
      const scoreTxt = (Number.isInteger(m.score?.home) && Number.isInteger(m.score?.away))
        ? `<strong>${m.score.home}–${m.score.away}</strong>${m.score?.outcome?` <span class="muted">(${m.score.outcome})</span>`:''}`
        : '';

      return `
        <tr class="fxRow ${cls}">
          <td class="fxCell nowrap">${fmtDate(m.date)}</td>
          <td class="fxCell nowrap">${fmtTime(m.date)}</td>
          <td class="fxCell"><span class="pill">${m.comp||''}</span></td>
          <td class="fxCell">${m.home||''}</td>
          <td class="fxCell">vs</td>
          <td class="fxCell">${m.away||''}</td>
          <td class="fxCell tv">${tvRaw||'TBD'}</td>
          ${showScore ? `<td class="fxCell">${scoreTxt}</td>
                         <td class="fxCell nowrap">
                           <a class="linkbtn" href="${sky}" target="_blank" rel="noopener">Sky</a>
                           <a class="linkbtn" href="${yt}"  target="_blank" rel="noopener">YT</a>
                         </td>` : ``}
        </tr>`;
    }

    wrap.innerHTML = `
      <div class="fixturesWrap">
        <div>
          <div class="sectionTitle">Upcoming</div>
          ${
            upcoming.length
              ? `<table class="fxTable">
                   <thead><tr class="muted"><th>Date (UK)</th><th>Time (UK)</th><th>Comp</th><th>Home</th><th></th><th>Away</th><th>TV</th></tr></thead>
                   <tbody>${upcoming.map(m=>row(m,false)).join('')}</tbody>
                 </table>`
              : `<div class="muted">No upcoming fixtures.</div>`
          }
        </div>

        <div>
          <div class="sectionTitle">Recent Results</div>
          ${
            recent.length
              ? `<table class="fxTable">
                   <thead><tr class="muted"><th>Date</th><th>Time</th><th>Comp</th><th>Home</th><th></th><th>Away</th><th>TV</th><th>Score</th><th>Highlights</th></tr></thead>
                   <tbody>${recent.map(m=>row(m,true)).join('')}</tbody>
                 </table>`
              : `<div class="muted">No recent results.</div>`
          }
        </div>
      </div>`;
  })();

  // header height var
  function setHeaderVar(){
    const h = document.getElementById('siteHeader')?.getBoundingClientRect().height || 72;
    document.documentElement.style.setProperty('--hdr', h+'px');
  }
  setHeaderVar(); addEventListener('resize', setHeaderVar);
})();
</script>
</body>
</html>
