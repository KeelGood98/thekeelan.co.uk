name: Update site data (TSDB table + MUFC fixtures)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "23 5 * * *"   # daily 05:23 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build assets
        env:
          # Optional: repo var to override season (e.g., 2026-2027)
          SEASON: ${{ vars.SEASON }}
        run: |
          python - <<'PY'
          import json, os, pathlib, time, urllib.request, datetime, sys

          # ---------------- helpers ----------------
          def get(url, tries=4, sleep=1.2):
            for i in range(tries):
              try:
                req = urllib.request.Request(url, headers={"User-Agent":"thekeelan-updater/1.0"})
                with urllib.request.urlopen(req, timeout=30) as r:
                  return json.loads(r.read().decode("utf-8"))
              except Exception as e:
                if i == tries-1:
                  print(f"[ERR] GET {url} -> {e}", file=sys.stderr)
                  raise
                time.sleep(sleep)

          def iso_ts(date_str, time_str):
            date_str = (date_str or "").strip()
            time_str = (time_str or "00:00:00").strip()
            if not date_str and not time_str: return ""
            ts = f"{date_str}T{time_str}"
            if not ts.endswith("Z"): ts += "Z"
            return ts

          # ---------------- season ----------------
          forced = (os.environ.get("SEASON") or "").strip()
          if forced:
            SEASON = forced
          else:
            today = datetime.date.today()
            SEASON = f"{today.year}-{today.year+1}" if today.month >= 8 else f"{today.year-1}-{today.year}"
          print(f"[INFO] Using season: {SEASON}")

          # ---------------- PL table ----------------
          # TSDB: Premier League league id = 4328
          table_api = f"https://www.thesportsdb.com/api/v1/json/3/lookuptable.php?l=4328&s={SEASON}"
          t = get(table_api) or {}
          rows = t.get("table") or []
          if not rows:
            print("[WARN] No rows from lookuptable; check season string.")

          standings = [{
              "pos": int(r.get("intRank") or 0),
              "team": r.get("strTeam") or "",
              "played": int(r.get("intPlayed") or 0),
              "won": int(r.get("intWin") or 0),
              "drawn": int(r.get("intDraw") or 0),
              "lost": int(r.get("intLoss") or 0),
              "gf": int(r.get("intGoalsFor") or 0),
              "ga": int(r.get("intGoalsAgainst") or 0),
              "gd": int(r.get("intGoalDifference") or 0),
              "pts": int(r.get("intPoints") or 0),
              "badge": r.get("strTeamBadge") or None
          } for r in rows]
          standings.sort(key=lambda x: x["pos"] or 999)

          table = {
            "season": SEASON,
            "updated": datetime.datetime.utcnow().isoformat()+"Z",
            "standings": standings
          }

          # ---------------- MUFC fixtures/results ----------------
          # Resolve exact team id
          search = get("https://www.thesportsdb.com/api/v1/json/3/searchteams.php?t=Manchester%20United") or {}
          teams = search.get("teams") or []
          if not teams:
            print("[ERR] No MUFC teams found.", file=sys.stderr); sys.exit(1)
          mu_names = {"manchester united", "man utd", "manchester u."}
          mu = None
          for tr in teams:
            if (tr.get("strTeam") or "").strip().lower() in mu_names:
              mu = tr; break
          mu = mu or teams[0]
          mu_id = mu["idTeam"]
          print(f"[INFO] MUFC team id: {mu_id}")

          # Use the season feed (contains past + future) to avoid flaky eventsnext
          season_feed = get(f"https://www.thesportsdb.com/api/v1/json/3/eventsseason.php?id={mu_id}&s={SEASON}") or {}
          items = season_feed.get("events") or []
          if not items:
            print("[WARN] No season events returned; fixtures may be empty.")

          def keep_mu(e):
            h = (e.get("strHomeTeam") or "").strip().lower()
            a = (e.get("strAwayTeam") or "").strip().lower()
            return h in mu_names or a in mu_names

          def map_event(e):
            # Prefer timestamp if present; otherwise compose from date/time
            ts = (e.get("strTimestamp") or "").strip()
            if not ts:
              ts = iso_ts(e.get("dateEvent"), e.get("strTime"))
            home = e.get("strHomeTeam") or ""
            away = e.get("strAwayTeam") or ""
            comp = e.get("strLeague") or (e.get("strLeagueShort") or "")
            hs, as_ = e.get("intHomeScore"), e.get("intAwayScore")
            finished = (hs is not None and as_ is not None)
            status = "FINISHED" if finished else "SCHEDULED"
            score = None
            if finished:
              hs, as_ = int(hs), int(as_)
              is_mu_home = home.strip().lower() in mu_names
              mu_score = hs if is_mu_home else as_
              opp_score = as_ if is_mu_home else hs
              outcome = "D" if mu_score == opp_score else ("W" if mu_score > opp_score else "L")
              score = {"home": hs, "away": as_, "outcome": outcome}
            return {"date": ts, "comp": comp, "home": home, "away": away, "status": status, "score": score}

          mapped = [map_event(e) for e in items if keep_mu(e)]

          # De-duplicate by date+teams (TSDB can repeat neutral/round variants)
          seen, dedup = set(), []
          for m in mapped:
            key = (m["date"], m["home"], m["away"])
            if key not in seen:
              seen.add(key)
              dedup.append(m)

          # Sort by date ascending; front-end slices upcoming/recent
          dedup.sort(key=lambda m: m["date"])

          fixtures = {
            "team": "Manchester United",
            "updated": datetime.datetime.utcnow().isoformat()+"Z",
            "matches": dedup
          }

          # ---------------- write ----------------
          assets = pathlib.Path("assets")
          assets.mkdir(exist_ok=True)
          (assets/"table.json").write_text(json.dumps(table, ensure_ascii=False, indent=2), encoding="utf-8")
          (assets/"fixtures.json").write_text(json.dumps(fixtures, ensure_ascii=False, indent=2), encoding="utf-8")
          (assets/"update_stamp.txt").write_text(datetime.datetime.utcnow().isoformat()+"Z", encoding="utf-8")
          print("Wrote assets/table.json and assets/fixtures.json")
          PY

      - name: Commit assets
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add assets/*
            git commit -m "chore: refresh assets ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
            git push
          else
            echo "No changes."
          fi
