name: Update fixtures (ESPN)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "23 5 * * *"   # daily 05:23 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build assets from ESPN
        run: |
          python - <<'PY'
          import json, os, urllib.request, datetime, sys, ssl
          ssl._create_default_https_context = ssl._create_unverified_context

          # ---- ESPN endpoints (correct) ----
          ESPN_SCHEDULE = "https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/teams/360/schedule"  # Man United id=360
          ESPN_TABLE    = "https://site.api.espn.com/apis/site/v2/sports/soccer/eng.1/standings"

          UA = {"User-Agent":"Mozilla/5.0"}

          def fetch(url):
            req = urllib.request.Request(url, headers=UA)
            with urllib.request.urlopen(req, timeout=60) as r:
              return json.loads(r.read().decode("utf-8"))

          def to_date_time(iso):
            try:
              d = datetime.datetime.fromisoformat(iso.replace("Z","+00:00"))
              return d.date().isoformat(), d.strftime("%H:%M")
            except Exception:
              return "", "TBC"

          # ---------- Fixtures (past + future) ----------
          data = fetch(ESPN_SCHEDULE)
          events = (data.get("events") or []) + (data.get("nextEvents") or [])

          fixtures = []
          for ev in events:
            date, time = to_date_time(ev.get("date",""))
            comps = (ev.get("competitions") or [{}])[0]
            comp_name = comps.get("name") or (ev.get("league") or "")
            comp_name = comp_name or "English Premier League"

            teams = comps.get("competitors") or []
            home, away = None, None
            for t in teams:
              if t.get("homeAway") == "home":
                home = t
              elif t.get("homeAway") == "away":
                away = t
            if not home or not away: 
              continue

            th, ta = home.get("team") or {}, away.get("team") or {}
            hname = th.get("displayName") or th.get("name") or ""
            aname = ta.get("displayName") or ta.get("name") or ""
            hbadge = th.get("logo") or (th.get("logos") or [{}])[0].get("href")
            abadge = ta.get("logo") or (ta.get("logos") or [{}])[0].get("href")

            status_name = (ev.get("status") or {}).get("type",{}).get("name","")
            if status_name == "STATUS_FINAL":
              hs = int(home.get("score") or 0); as_ = int(away.get("score") or 0)
              score, st = f"{hs}â€“{as_}", "FT"
            elif status_name == "STATUS_SCHEDULED":
              score, st = None, "UPCOMING"
            else:
              score, st = None, "upcoming"

            fixtures.append({
              "date": date, "time": time or "TBC", "comp": comp_name,
              "home": hname, "away": aname, "status": st, "score": score,
              "venue": (comps.get("venue") or {}).get("fullName") or "",
              "tv": [], "homeBadge": hbadge, "awayBadge": abadge,
            })

          # dedup + sort
          seen, clean = set(), []
          for f in fixtures:
            k = (f["date"], f["home"], f["away"])
            if f["date"] and k not in seen:
              seen.add(k); clean.append(f)
          clean.sort(key=lambda x: (x["date"], x["time"], x["home"], x["away"]))
          os.makedirs("assets", exist_ok=True)
          with open("assets/fixtures.json","w",encoding="utf-8") as out:
            json.dump(clean, out, ensure_ascii=False, indent=2)
          print("fixtures written:", len(clean))

          # ---------- Standings (full table) ----------
          tdata = fetch(ESPN_TABLE)

          # Drill into children/standings/entries; formats vary a bit
          def first_entries(obj):
            # try children -> standings -> entries
            for g in obj.get("children", []):
              st = g.get("standings") or {}
              ent = st.get("entries")
              if ent:
                return ent
            # fallback: standings -> entries at root
            st = obj.get("standings") or {}
            return st.get("entries") or []

          entries = first_entries(tdata)
          table, rank = [], 1
          for e in entries:
            team = e.get("team") or {}
            name = team.get("displayName") or team.get("name") or ""
            crest = team.get("logo") or (team.get("logos") or [{}])[0].get("href")
            stats = e.get("stats") or []

            def get(n, default=0):
              for s in stats:
                if s.get("name")==n:
                  try: return int(s.get("value"))
                  except: return default
              return default

            played = get("gamesPlayed")
            win    = get("wins")
            draw   = get("ties")
            loss   = get("losses")
            gf     = get("pointsFor") or get("goalsFor")
            ga     = get("pointsAgainst") or get("goalsAgainst")
            gd     = gf - ga
            points = get("points")

            table.append({
              "rank": rank, "team": name, "played": played,
              "win": win, "draw": draw, "loss": loss,
              "gf": gf, "ga": ga, "gd": gd, "points": points,
              "badge": crest,
            })
            rank += 1

          with open("assets/table.json","w",encoding="utf-8") as out:
            json.dump(table, out, ensure_ascii=False, indent=2)
          print("table written:", len(table))

          # bump a stamp so Pages rebuilds
          from datetime import timezone
          with open("assets/update_stamp.txt","w",encoding="utf-8") as f:
            f.write(datetime.datetime.now(timezone.utc).isoformat())
          PY

      - name: Commit & push (always)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add assets/*
          if git diff --cached --quiet; then
            git commit --allow-empty -m "chore: force pages rebuild (ESPN fixed) [skip ci]"
          else
            git commit -m "chore: update fixtures & table from ESPN (fixed endpoints) [skip ci]"
          fi
          git push
